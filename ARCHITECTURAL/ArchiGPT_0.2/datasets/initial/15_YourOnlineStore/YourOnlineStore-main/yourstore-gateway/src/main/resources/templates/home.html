<!DOCTYPE html>
<html>

<head>
<!-- Basic -->
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<!-- Mobile Metas -->
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<!-- Site Metas -->
<meta name="keywords" content="" />
<meta name="description" content="" />
<meta name="author" content="" />
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script
	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<link rel="shortcut icon" href="/images/logo.png" type="">
<title>YourOnlineShop - Home</title>
<!-- bootstrap core css -->
<link rel="stylesheet" type="text/css" href="/css/bootstrap.css" />
<!-- font awesome style -->
<link href="/css/font-awesome.min.css" rel="stylesheet" />
<!-- Custom styles for this template -->
<link href="/css/style.css" rel="stylesheet" />
<!-- responsive style -->
<link href="/css/responsive.css" rel="stylesheet" />

<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
	integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
	crossorigin="anonymous"></script>

</head>

<body>
	<div class="">
		<!-- header section strats -->
		<header class="header_section"
			style="background-color: rgb(162, 38, 36); box-shadow: 5px 5px 2px; height: 200px;">
			<div class="container heading_center" style="">
				<a class="navbar-brand" href="/home"> <img
					width="150px
                     " src="/images/logo.png" /></a>
			</div>
			
			<div class="form-group">

				<nav style="display: flex; justify-content: center;"
					class=" mt-xl-5 navbar navbar-expand-lg custom_nav-container ">

					<button class="navbar-toggler" type="button" data-toggle="collapse"
						data-target="#navbarSupportedContent"
						aria-controls="navbarSupportedContent" aria-expanded="false"
						aria-label="Toggle navigation"></button>

					<div class="collapse navbar-collapse" id="navbarSupportedContent">
						<ul class="navbar-nav">
							<div style="background-color: rgb(215, 58, 51);" class="mr-sm-2 admin">
								<a href="/analytics" class="btn btn-lg admin" style="display: none">Admin Analytics
								</a>
							</div>
							<div style="background-color: rgb(215, 58, 51);" class="mr-sm-2 admin">
								<a href="/addProduct" class="btn btn-lg admin" style="display: none">Aggiungi Prodotto <span
									style="color: rgb(43, 43, 43);"
									class="glyphicon glyphicon-plus"></span>
								</a>
							</div>
							<div style="background-color: rgb(215, 58, 51);" class="mr-sm-2 authenticated" id="HistoryOrdersDIV">
								<a href="/listOrder" class="btn btn-lg authenticated" id="HistoryOrdersATT" style="display: none">History Orders</a>
							</div>
							<div style="background-color: rgb(215, 58, 51);" class="mr-sm-2 unauthenticated" id="loginDiv">
								<a href="http://localhost:8014/store/login" class="btn btn-lg" id="loginAtt">Login</a>
							</div>
							<div class="authenticated" id="loginAuthDiv" style="background-color: rgb(215, 58, 51);">
								<button  onClick="logout()" class="btn btn-lg authenticated" style="display: none; background-color: rgb(215, 58, 51);">Logout</button>
							</div>
							<div id="carello" class="mr-sm-2">

								<div class=" dropdown dropdown-item" onclick="">
									<li class="fa fa-shopping-cart " type="button"
										style="font-size: 30px; margin-right: 10px" id="dropdownMenu2"
										data-bs-toggle="dropdown" aria-expanded="false"></li>
									<div class="dropdown-menu" aria-labelledby="dropdownMenu2">
										<li class="">
											<div class="container dropdown-item"
												style="width: max-content;">
												<div class="row" id="dropDownCart"
													style="width: 300px; overflow-y: auto; white-space: nowrap;">

												</div>
										</li> <a href="/shipping" class="btn btn-primary"
											style="margin-top: 10px; margin-left: 10px;" id="BottoneGoToTheCart">Go to the
											cart</a>
									</div>
								</div>
							</div>
							<div
								style="display: -ms-flexbox; display: flex; -ms-flex-align: center; align-items: center; visibility: hidden;">
								<form class="input-group">

									<input style="width: 180px;" class="form-control mr-sm-2 "
										type="search" placeholder="Search" aria-label="Search">
									<button
										style="width: 70px; color: rgb(215, 58, 51); border-color: rgb(215, 58, 51);"
										class=" form-control btn btn-outline-info my-2 my-sm-0"
										type="submit">
										<span style="color: black">Search 
									</button>
								</form>
							</div>
						</ul>
					</div>	
			</div>
			</nav>
	</div>
	</header>
	<!-- end header section -->
	</div>
	<!-- product section -->
	<section class="product_section layout_padding">
		<div class="container">
			<div class="heading_center">
				<p align="center" id="user" style="font-size: 45px; margin-top: -60px; font-style: Farmstand"></p>
				<br>
				<p align="center" style="font-size: 40px;">Our products</p>
				<hr
					style="height: 2px; border-width: 2; color: #000000; background-color: #f7444e; box-shadow: 5px #000000;">
			</div>
			<div class="row" id="elencop"></div>

		</div>
	</section>
	<div class="btn btn-dark " id="ViewAllProduct"
		style="display: block; margin-left: auto; margin-right: auto; width: 40%; margin-top: -20px; margin-bottom: 30px"
		onclick="addProductAll()">View All products</div>
	<!-- end product section -->

	<!-- jQery -->
	<script src="/js/jquery-3.4.1.min.js"></script>
	<!-- popper js -->
	<script src="/js/popper.min.js"></script>
	<!-- bootstrap js -->
	<script src="/js/bootstrap.js"></script>
	<!-- custom js -->
	<script src="/js/custom.js"></script>

</body>
<!-- Script per caricare i prodotti all'interno della home  -->

<script type="text/javascript">
	//-------------------------Utente----------------------------------------------------
	localStorage.removeItem("isAdmin");
	var theUtenteObjectKey = ""
	var isAdmin = false;
	$.get("/store/user", function(data) {
		if(data) {
			console.log(data);
			$("#user").html("Benvenuto " + data.name);
        	$(".unauthenticated").hide()
        	$(".authenticated").show()
			$.get("/store/utenteId?id=" + data.id, function(utente) {
				console.log("Id Utente: " + utente.id);
				theUtenteObjectKey = utente.id;
				localStorage.setItem("isAdmin", data.id)
				if(utente.isAdmin) {
					isAdmin = utente.isAdmin;
					$(".admin").show()
					
				}
				onLoad();
			});
		}
		else {
			$(".authenticated").hide()
        	$(".unauthenticated").show()
			onLoad();
		}        
    });
	

	var logout = function() {
    $.post("/store/logout", function() {
        $("#user").html('');
        $(".unauthenticated").show();
        $(".authenticated").hide();
        
        
    })
    location.reload();
    return true;
	}

	function onLoad() {
		loadProduct();
		loadRecentOrder();
		aggiornaHrefShipping();
	}
	
	//------------------------------------loadProduct---------------------------------------------------
	var products
	function loadProduct(e) {
		var httpRequest = new XMLHttpRequest();
		httpRequest.onreadystatechange = reaction;
		httpRequest.open("GET", "http://localhost:8080/database/product/all",
				true);
		httpRequest.send();
	}
	function reaction(e) {
		if (e.target.readyState == XMLHttpRequest.DONE) {
			var i = 0;
			var json = e.target.responseText;
			var jsonparse = JSON.parse(json)
			addProduct("elencop", jsonparse)
		}
	}
	function addProduct(tableID, content) {
		var elencop = document.getElementById(tableID);
		products = content
		for (var i = 0; i < content.length; i++) {
			if (i == 3)
				break
			var prod = content[i];
			// 			if (d.length >= 31)
			// 				d = d.substring(0, 28) + "...";
			if (i == 1) {
				elencop
						.insertAdjacentHTML(
								"beforeend",
								'<div class="col-sm-6 col-md-4 col-lg-4" id="lastProduct">'
										+ '<div class="box">'
										+ '<div class="option_container">'
										+ '<div class="options">'
										+ '<p style=" font-size:15px;" class="option3 detail-box ">Disponibility: '
										+ prod.disponibility
										+ '</p>'
										+ '<a style=" font-size:15px;" onclick="insertProductToCart('
										+ prod.productId
										+ ')" class="option1 btn" id="'
										+ i
										+ '"> Add to cart </a><a style=" font-size:15px;" href="/product/'+prod.productId+'"  class="option2 btn " >View The Product</a>'
										+ '</div>'
										+ '</div>'
										+ '<div class="img-box">'
										+ '<img src="'+prod.imageUrl+'" alt="">'
										+ '</div>'
										+ '<div class="detail-box">'
										+ '<h5>'
										+ prod.productName
										+ '</h5>'
										+ '<h5>'
										+ prod.cost
										+ '€</h5>'
										+ '</div>' + '</div>' + '</div>');
			} else {
				elencop
						.insertAdjacentHTML(
								"beforeend",
								'<div class="col-sm-6 col-md-4 col-lg-4">'
										+ '<div class="box">'
										+ '<div class="option_container">'
										+ '<div class="options">'
										+ '<p style=" font-size:15px;" class="option3 detail-box ">Disponibility: '
										+ prod.disponibility
										+ '</p>'
										+ '<a style=" font-size:15px;" onclick="insertProductToCart('
										+ prod.productId
										+ ')" class="option1 btn" id="'
										+ i
										+ '"> Add to cart </a><a style=" font-size:15px;" href="/product/'+prod.productId+'"  class="option2 btn " >View The Product</a>'
										+ '</div>'
										+ '</div>'
										+ '<div class="img-box">'
										+ '<img src="'+prod.imageUrl+'" alt="">'
										+ '</div>'
										+ '<div class="detail-box">'
										+ '<h5>'
										+ prod.productName
										+ '</h5>'
										+ '<h5>'
										+ prod.cost
										+ '€</h5>'
										+ '</div>' + '</div>' + '</div>');
			}
		}

	}
	//----------------------ViewAllProduct---------------------------------------------------

	function addProductAll(tableID) {
		var elencop = document.getElementById("elencop");
		var bnt = document.getElementById("ViewAllProduct");
		var content = products
		for (var i = 0; i < content.length; i++) {
			if (i < 3) {
			} else {
				var prod = content[i];
				// 			if (d.length >= 31)
				// 				d = d.substring(0, 28) + "...";
				elencop
						.insertAdjacentHTML(
								"beforeend",
								'<div class="col-sm-6 col-md-4 col-lg-4" id="lastProduct">'
								+ '<div class="box">'
								+ '<div class="option_container">'
								+ '<div class="options">'
								+ '<p style=" font-size:15px;" class="option3 detail-box ">Disponibility: '
								+ prod.disponibility
								+ '</p>'
								+ '<a style=" font-size:15px;" onclick="insertProductToCart('
								+ prod.productId
								+ ')" class="option1 btn" id="'
								+ i
								+ '"> Add to cart </a><a style=" font-size:15px;" href="/product/'+prod.productId+'"  class="option2 btn " >View The Product</a>'
								+ '</div>'
								+ '</div>'
								+ '<div class="img-box">'
								+ '<img src="'+prod.imageUrl+'" alt="">'
								+ '</div>'
								+ '<div class="detail-box">'
								+ '<h5>'
								+ prod.productName
								+ '</h5>'
								+ '<h5>'
								+ prod.cost
								+ '€</h5>'
								+ '</div>' + '</div>' + '</div>');
			}
		}
		bnt.style.visibility = "hidden"
	}
	//------------------------------------insertProductToCart--------------------------------------------------------

	var objectKeyOrdine = ""
		function insertProductToCart(idProduct) {
		console.log("questo è l'idIndedx del prodotto aggiunto: " + idProduct)
		var dropDownCart = document.getElementById("dropDownCart");
		dropDownCart.innerHTML = ""
		if (theUtenteObjectKey!="") {
			$.ajax({
				type : "GET",
				url : "http://localhost:8080/store/ordine/current-ordine/"
						+ theUtenteObjectKey,
				success : function(result) {
					// 						var indexSelected
					// 						for (var i = 0; i < content.length; i++) {
					// 							if (content[i].date == null)
					// 								indexSelected = i
					// 						}
					objectKeyOrdine = result.ordineId
					console.log(result)
					console.log("questo è l'ordine corrente: "
							+ objectKeyOrdine)
					$
							.ajax({
								type : "GET",
								url : "http://localhost:8080/store/order-item/findByTheProduct/"
										+ idProduct,
								success : function(result) {
									console
											.log("http://localhost:8080/store/order-item/findByTheProduct/")
									console.log(result)
									var amount = 1
									if (result.content.length > 0
											&& result.content[result.content.length - 1].theOrdineObjectKey == objectKeyOrdine) {
										//l'ultimo elemento della lista è sempre quello aggiunto nel nuovo ordine
										const content = result.content[result.content.length - 1]

										amount =  parseInt(content.amount) + parseInt(amount)
										const body = '{"amount":'
												+ amount
												+ ',"theOrdineObjectKey":'
												+ objectKeyOrdine
												+ ',"theProductObjectKey":'
												+ idProduct
												+ '}';
										//const body = "{amount:1,theOrdineObjectKey:"+userId+",\n\"theProductObjectKey\":"+products[idIndex].productId+"}"
										$
												.ajax({
													type : "PUT",
													url : "http://localhost:8080/store/order-item",
													data : body,
													contentType : "application/json",
													success : function(
															result) {
														console
																.log("ajax: abbiamo modificato l'amount del prodotto adesso è: "
																		+ result.amount
																		+ " + 1")
														loadRecentOrder()
													},
													error : function(e) {
														alert("Errore" + e);
													}
												})
									} else if (result.content.length > 0
											&& result.content[result.content.length - 1].theOrdineObjectKey != objectKeyOrdine) {
										const body = '{"amount":'
												+ amount
												+ ',"theOrdineObjectKey":'
												+ objectKeyOrdine
												+ ',"theProductObjectKey":'
												+ idProduct
												+ '}';
										$
												.ajax({
													type : "POST",
													url : "http://localhost:8080/store/order-item",
													data : body,
													contentType : "application/json",
													success : function(
															result) {
														console
																.log("ajax: abbiamo modificato l'amount del prodotto adesso è: "
																		+ result.amount
																		+ " + 1")
														loadRecentOrder()
													},
													error : function(e) {
														alert("Errore" + e);
													}
												})

									} else {
										const body = '{"amount":'
												+ amount
												+ ',"theOrdineObjectKey":'
												+ objectKeyOrdine
												+ ',"theProductObjectKey":'
												+ idProduct
												+ '}';
										//const body = "{amount:1,theOrdineObjectKey:"+userId+",\n\"theProductObjectKey\":"+products[idIndex].productId+"}"
										$
												.ajax({
													type : "POST",
													url : "http://localhost:8080/store/order-item",
													data : body,
													contentType : "application/json",
													success : function(
															result) {
														console
																.log("ajax: Abbiamo aggiunto il prodotto all'interno dell'ordine")
														loadRecentOrder()
													},
													error : function(e) {
														alert("Errore non è stato possibile aggiungere il prodotto"
																+ e);
													}
												})
									}

								},
								error : function(e) {
									alert("Errore" + e);
								}
							})
				},
				error : function(e) {
					alert("Errore" + e);
				}
			})
		}
		else{
			window.alert("Non puoi aggiungere al carello, se non hai effettuato il login")
		}
			
	}
	// ------------- Script per acquisire i prodotti dell'ultimo ordine (non ancora acquistato) di uno specifico utente 
	var objectKeyOrdine
	function loadRecentOrder(e) {
		if (theUtenteObjectKey != "") {
			currentOrdineRequest();
		}

	}
	function currentOrdineRequest() {
		var httpRequest = new XMLHttpRequest();
		httpRequest.onreadystatechange = reactionFirst;
		httpRequest.open("GET",
				"http://localhost:8080/store/ordine/current-ordine/"
						+ theUtenteObjectKey, true);
		httpRequest.send();
	}
	function reactionFirst(e) {
		if (e.target.readyState == XMLHttpRequest.DONE) {
			var i = 0;
			var json = e.target.responseText;
			var jsonparse = JSON.parse(json)
			putTheProductOnPage(jsonparse)
		}
	}
	//lista ID prodotti dell'ultimo ordine
	var productsId = []
	var totalCostNumber = Number("0")
	function putTheProductOnPage(content) {
		objectKeyOrdine = content.ordineId
		console.log(objectKeyOrdine)
		console.log(content)
		$
				.ajax({
					type : "GET",
					url : "http://localhost:8080/store/order-item/findByTheOrdine/"
							+ objectKeyOrdine,
					success : function(result) {
						console
								.log("http://localhost:8080/store/order-item/findByTheOrdine/")
						console.log(result.content)
						for (var i = 0; i < result.content.length; i++) {
							if (result.content[i].theOrdineObjectKey == objectKeyOrdine) {
								console.log(objectKeyOrdine)
								productsId
										.push(result.content[i].theProductObjectKey)
							}
						}
						console.log(productsId)

						// // 		//chiamata allo stock per prendere i dati dei prodotti, in modo tale da poterli raffigurare front-end
						for (var i = 0; i < productsId.length; i++) {

							$.ajax({
								type : "GET",
								url : "http://localhost:8080/database/product/"
										+ productsId[i],
								success : function(result) {
									console.log(result)
									addProductToForm(result)
								},
								error : function(e) {
									alert("Errore" + e);
								}
							})
						}
						productsId = []
					},
					error : function(e) {
						alert("Errore" + e);
					}
				})

	}

	function addProductToForm(productDetail) {
		var dropDownCart = document.getElementById("dropDownCart");
		dropDownCart
				.insertAdjacentHTML(
						"beforeend",
						'<div class="col-sm-6 col-md-4 col-lg-4 mt-2" id="ProductOnCart'+productDetail.productId+'">'
								+ '<div class="box">'
								+ '<div class="img-box">'
								+ '	<img src="'+productDetail.imageUrl+'" width="50px"'
										+'		style="margin-left: 20px;">'
								+ '	</div>'
								+ '</div>'
								+ '</div>'
								+ '<div class=" col-lg-4" style="overflow-x: auto;white-space: nowrap;width: 50px;">'
								+ '<div class="box" >'
								+ '	<div class=" detail-box" >'
								+ '		<h5>'
								+ productDetail.productName
								+ '</h5>'
								+ '		<h5>'
								+ productDetail.cost
								+ '€</h5>'
								+ '	</div>'
								+ '	</div>'
								+ '</div>'
								+ '<div class=" col-lg-4">'
								+ '<div class="detail-box" >'
								+ '<h5 id="AmountOnCart'+productDetail.productId+'">'
								+ "x "
								+ '</div>'
								+ '</h5>'
								+ '	</div>'
								+ '	</div>')
		RefreshAmount(productDetail.productId)
	}

	function RefreshAmount(productId) {
		$.ajax({
			type : "GET",
			url : "http://localhost:8080/store/order-item/" + objectKeyOrdine
					+ "~" + productId,
			success : function(result) {
				const AmountProductOnCart = document
						.getElementById("AmountOnCart" + productId);
				AmountProductOnCart.innerHTML = "x " + result.amount
			},
			error : function(e) {
				alert("Errore" + e);
			}
		})

	}

	// Aggiorna href
	function aggiornaHrefShipping(){
		var BottoneGoToTheCart = document.getElementById("BottoneGoToTheCart");
		if (theUtenteObjectKey==""){
			var dropDownCart = document.getElementById("dropDownCart");
			BottoneGoToTheCart.style = "visibility: hidden"
			dropDownCart.innerHTML = '<p class="fs-1">Login to see your cart</p>'
		}
	}

</script>


</html>
<!----[
   {
      "productId":1,
      "productName":"Test",
      "cost":2.99,
      "disponibiliy":99,
      "description":"Test description",
      "imageUrl":"pImage.png"
   }
]--->